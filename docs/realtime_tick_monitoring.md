# 实时 Tick 监控 & 调整指引

本指引用于明天实盘运行前后快速核对关键指标、识别 ClickHouse 写入/队列压力，并据此决定是否需要调整线程数或抓取节奏。

## 1. 运行前准备
- 确认 `app/tasks/realtime_tick_fetcher.py` 已更新到最新版本。
- 预估本交易日需要采集的股票数量（含沪深所有标的），初始线程数会根据数量自动调整，无需手动干预。
- 确保 ClickHouse 可用，网络延迟稳定；日志默认会打印到标准输出及日志系统。

## 2. 运行中监控信息
抓取任务每分钟会输出一条统计日志，包含以下指标：

| 指标 | 含义 | 关注点 |
| --- | --- | --- |
| `成功/失败` | 抓取批次次数 | 失败持续增加需确认外部 API |
| `总行数` | 已写入行数 | 判断整体吞吐 |
| `重试` | 写入重试/网络异常次数 | 多次 >5 说明 ClickHouse/网络异常 |
| `写入异常` | 写线程 insert 重试次数 | 同上 |
| `队列当前/峰值` | 写队列实时大小与历史峰值 | 达到容量 80% 会有警告 |
| `丢弃` | 因队列满导致丢弃的 tick 数 | 非 0 需立即处理 |
| `平均抓取/写入` | 近样本平均耗时（毫秒） | 抓取 >3000ms 或写入 >5000ms 说明存在瓶颈 |

此外，日志中还会出现：
- `写入队列压力增大`：队列占比 ≥80%，继续累积可能导致丢弃。
- `批量写入ClickHouse失败`：记录写入重试详情。

## 3. 队列压力下的操作建议
1. **队列 ≥80% 且持续增长**  
   - 检查统计中 `平均写入` 是否明显高于 `fetch_interval`（3 秒）。  
   - 可手动下调线程数或增大 `fetch_interval`：  
     - 线程数：在配置中暂时将 `max_workers` 设为 `max(current_workers - 2, 2)`。  
     - 间隔：在设置里把 `fetch_interval` 调至 4–5 秒，观察 1 轮后恢复。  
   - 如果写线程重试频繁（`写入异常` > 5），优先排查 ClickHouse 状态。

2. **出现丢弃数据**  
   - 立即暂停新增抓取线程（可临时停止任务），检查 ClickHouse 状态。  
   - 如需快速恢复，可临时提升 `max_queue_size` 或在 ClickHouse 恢复后重新启动任务。

3. **抓取耗时明显上涨**（`平均抓取` > 3s）  
   - 说明外部 API 慢，可保持现有线程，但考虑拉长 `fetch_interval` 或减少批次数，防止排队。

## 4. 反馈提示词模板
请按以下模板提供反馈（复制后填入实际数值/描述）：

```
【实时Tick运行反馈】
- 股票总数：{total_stocks}
- 使用线程：{worker_count}，fetch_interval：{fetch_interval}s
- 统计日志样例：{paste last stats line}
- 平均抓取耗时(ms)：{avg_fetch_ms}
- 平均写入耗时(ms)：{avg_insert_ms}
- 队列当前/峰值：{queue_current}/{queue_peak}
- 重试次数：抓取 {fetch_retries}，写入 {insert_retry_attempts}
- 写入异常次数：{writer_failures}
- 丢弃条数：{dropped_rows}
- 看到的警告/错误：{warnings_or_errors}
- 其它观察（如 ClickHouse 负载、网络状况）：{other_notes}
```

> **提示**：统计日志直接复制即可，其中包含队列/耗时指标；若有多条警告，请列出代表性的 1–2 条。

## 5. 后续计划
- 根据反馈数据，我们将决定是否引入自动降速（当队列逼近上限时自动降低 `worker_count` 或延长 `fetch_interval`）以及是否需要对接 Prometheus/飞书报警。  
- 若需要将日志联动到现有监控平台，可在 log pipeline 中针对“统计”“压力”“写入失败”关键字建立告警规则。

如有额外指标需求（例如 CPU、网络延迟等），可在反馈中补充，我们再扩展监控范围。
